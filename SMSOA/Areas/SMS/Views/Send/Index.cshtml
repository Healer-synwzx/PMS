
@{
    ViewBag.Title = "View";
    Layout = "~/Areas/SMS/Views/Shared/_Layout_Send.cshtml";
}

@section Scripts{
    <script type="text/javascript">

        function formatItem_combobox(row) {
            var s = '<input type="checkbox" class="combobox-checkbox">' + '<span style="font-weight:bold">' + row.text + '</span></input>';
            return s;
        }

        function split4phone(obj, temp) {
            var phones = "";

            $.each(obj, function (index, data) {
                //if (data["isTemp"] == 2) {
                    phones = phones + data[temp] + ",";
                //}
            })
            return phones = phones.substr(0, phones.length - 1);
        }



        

        function append() {
           
            //获取添加的内容
            var phone= $("#txt_addPerson").val();
            //向表格中追加
            var row_temp= {
                PName: '临时联系人',
                isVIP: true,
                PhoneNum: phone
            };

            //使用以下方式只能使用appenRow方法insertRow会有错
            //var row_temp = new Object();            
            //row_temp.PID=-1;
            //row_temp.PName = '临时联系人';
            //row_temp.isVIP = true;
            //row_temp.PhoneNum = phone;
            //row_temp.isTemp = 2;
            //$('#person_temp_datagrid').datagrid('appendRow', row_temp); 

            $('#person_temp_datagrid').datagrid('insertRow', {
                index: 0,	// 索引从0开始
                row: row_temp});      
            $('#person_temp_datagrid').datagrid('checkRow', 0); 
        }

        //function OnChecks() {
        //    var ids= $("#group_combogrid").combobox("getChecked");
        //}


        //异步提交
        function AjaxSubmit(pids,phones, content,url,missionId,groupIds,departmentIds,isTiming,startRunTime,uid) {
            //1 创建对象
            var model = new Object();
            model.PersonIds = pids;
            model.PhoneNums=phones;
            model.Content = content;
            model.SMSMissionID = missionId;
            model.GroupIds=groupIds;
            model.DepartmentIds=departmentIds;
            model.StartRunTime=startRunTime;
            model.isTiming=isTiming;
            model.UID=uid;
            //2 使用ajax方式提交（此处先不用post）
            $.ajax({
                url: url,
                data: JSON.stringify(model),
                contentType: 'application/json;charset=utf-8',//注意此处必须注明为json格式，否则后台控制器无法通过Model的方式接收
                async: true,
                type: 'POST',
                beforeSend: function () {
                    messagerShowOnCenter("提交","已经提交");
                },
                success: function (data) {
                    if("ok" == data){
                        messagerShowOnCenter("提示","提交成功");
                    }else if("empty contact list" == data){
                        messagerShowOnCenter("错误","联系人名单为空，发送失败")
                    }else if("out of range" == data){
                        messagerShowOnCorner("提示","短信字数超过300字，提交失败");
                       
                    }else if("empty content" == data){
                        messagerShowOnCorner("提示","短信内容为空，发送失败");
                      
                    }
                }

            })
        }

        //编辑或创建某个权限后执行的操作
        function afterEdit(msg) {
            //editWindow
            //1 关闭加载的iframe页面
            $.messager.alert('提示', msg);

            $("#editWindow").window('close');
            //2 刷新当前页面
            //$("#contactstreegrid").treegrid('reload');
            //loadPersonGridByGID("@ViewBag.GetPersonUrl", PersonColumns, PersonToolbar);
            //6月17日添加
            //注意需要重新加载短信任务下拉框（不必加载群组及部门下拉框——因为这两个下拉框是在点击短信任务后才会加载）
            loadCombogrid_byUser();
        }

        function DoSend() {
            //alert("要发送短信了");
            //1 获取右侧联系人datagrid列表中选中的联系人id
            var state= messagerConfirm("请确认","是否要执行发送短信操作?",function(){

                //1 获取选中的群组及部门
                //var group_checkeds = $("#group_combogrid").combogrid("getChecked");
                var group_checkeds =  $("#group_combogrid").combobox('getValues');
                //var department_checkeds = $("#DepartmentName_combotree").combotree("getChecked");
                var department_checkeds =  $("#DepartmentName_combotree").combobox('getValues');
                //var checkeds = $("#persondatagrid").datagrid("getChecked");
                var temp_checkeds = $("#person_temp_datagrid").datagrid("getChecked");
                if(group_checkeds.length>0||department_checkeds.length>0||temp_checkeds.length>0){
                    //1.1 获取选中的联系人id用,分隔，并提交
                    //var ids_person = split4id(checkeds, "PID");
                    //注意此处为[1,...2]这种数组，需要将其拼接为1,...2字符串
                    var ids_person = arr_UnSelectPersonIds.join(",");
                    var phones_temp = split4phone(temp_checkeds, "PhoneNum");
                    var url='@ViewBag.DoSend';
                    //2 获取短信内容
                    var content = $("#message").textbox('getValue');
                    var grid_mission= $("#smsMission_combogrid").combogrid("grid");
                    var mission_checkeds = grid_mission.datagrid("getChecked");
                    var mission_id = mission_checkeds[0]["SMID"];

                    //var istiming=$("#isTiming").val();
                    //if(istiming=="on"){
                    //    istiming=true;
                    //}else{
                    //    istiming=false;
                    //}

                    var startRunTime=$("#nextRunTime_date").datetimebox('getValue');
                    //alert("要发送的联系人为："+ids_person+"——短信内容为："+content);
                    //3 发送（进行校验）
                    AjaxSubmit(ids_person,phones_temp, content, url, mission_id,group_checkeds,department_checkeds,istiming,startRunTime,userId);
                    return;
                }
                messagerAlertByAlert("提示","请选择至少一个任务或群组");
            });
            //if(state==false){
            //    return;
            //}
            
        }

        function ClearContent() {
            //清除发送短信内容
            $("#message").textbox('setValue','');
            //alert("清除短信内容");
        }



        function CancelSend() {
            alert("取消发送短信");
        }

        function CloseWindow() {
            $("#editWindow").window('close');
           
        }
        var userId=-999;
        //思路如下：
        // 页面加载之前将isLoadSuccess_Person设置为false，页面加载过程中会触发onSelect及onCheck事件，此时不执行写在onSelect中的方法，只有在页面加载后才会执行onSelect中的方法
        var isLoadSuccess_Person = false;
        var isLoadSuccess_Group=false;
        var isLoadSuccess_Department=false;
        //----------------------------加载几个下拉框(放入模板页，短彩信共用)-----------------------------


        



        function  addPerson_Temp() {
            alert("添加");
        }

        


        //暂时不使用


        


</script>
    }

@section Body{
@Html.Partial("_Partial_Send_Body")
@Html.Partial("_Partial_Send_EditWin")
    }

